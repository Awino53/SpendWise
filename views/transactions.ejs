<!DOCTYPE html>
<html>
  <head>
    <title>Home</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .notification {
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .notification.bill {
        background-color: #fffae6;
        border-left: 5px solid #ff9800;
      }
      .notification.debt {
        background-color: #ffe6e6;
        border-left: 5px solid #f44336;
      }
    </style>
  </head>
  <body>
    <!-- Include the header partial -->
    <%- include('header.ejs') %>

    <h1>Budget Overview</h1>
    <!-- <a href="/logout">Logout</a> -->

    <!-- Notifications Section -->
    <div>
      <h2>Notifications</h2>
      <% if (notifications.length === 0) { %>
      <p>No notifications at the moment.</p>
      <% } else { %> <% notifications.forEach((notification) => { %>
      <div class="notification <%= notification.type %>">
        <p><%= notification.message %></p>
      </div>
      <% }); %> <% } %>
    </div>

    <!-- Pie Chart Section -->
    <div>
      <h3>Budget Allocation</h3>
      <canvas id="budgetDoughnutChart"></canvas>
    </div>

    <!-- Editable Tables for Transactions -->
    <div>
      <h2>Transaction Details</h2>
      <% budgetStatus.forEach((category) => { %>
      <h3><%= category.category %></h3>
      <table border="1" style="width: 100%; text-align: left">
        <thead>
          <tr>
            <th>Description</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% category.transactions.forEach((transaction) => { %>
          <tr>
            <td><%= transaction.description %></td>
            <td><%= transaction.amount %></td>
            <td><%= transaction.date %></td>
            <td>
              <form
                method="POST"
                action="/edit-transaction/<%= transaction.transaction_id %>"
              >
                <input
                  type="text"
                  name="description"
                  value="<%= transaction.description %>"
                  required
                />
                <input
                  type="number"
                  name="amount"
                  value="<%= transaction.amount %>"
                  step="0.01"
                  required
                />
                <input
                  type="date"
                  name="date"
                  value="<%= transaction.date %>"
                  required
                />
                <button type="submit">Save</button>
              </form>
              <form
                method="POST"
                action="/delete-transaction/<%= transaction.transaction_id %>"
                style="display: inline"
              >
                <button type="submit">Delete</button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
      <% }); %>
    </div>

    <script>
      // Budget Pie Chart Logic
      const budgetData = JSON.parse(
        "<%= JSON.stringify(budgetStatus.map(item => item.totalSpent)) %>"
      );
      const budgetLabels = JSON.parse(
        "<%= JSON.stringify(budgetStatus.map(item => item.category)) %>"
      );

      const ctx = document
        .getElementById("budgetDoughnutChart")
        .getContext("2d");
      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: budgetLabels,
          datasets: [
            {
              data: budgetData,
              backgroundColor: ["#4caf50", "#2196f3", "#ff9800", "#f44336"],
            },
          ],
        },
      });
    </script>
  </body>
</html>